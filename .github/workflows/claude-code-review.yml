name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Please review this pull request and provide feedback on:
            - Code quality and best practices
            - Potential bugs or issues
            - Security concerns (are security assumptions grouped in one place which is simple to review?)
            - DRY (also in md. md shouldn't repeat code and shouldn't write the same thing twice, like "reminder: how to run the backend: ...")
            - Scope creep (is the PR trying to solve too many problems at once?)
            - API changes / function signature changes (clean readable APIs are more important than the implementation)
            - UX / user flow problems ("don't make me think")

            Things that don't matter:
            - Performance (it is better to keep simple maintainable code. avoid premature optimization.)

            If you feel like it:
            - If you notice something out-of-scope-for-the-PR that bugs you or you feel like improving for any reason, you can suggest it as a follow up task, each such task as a bullet point phrased as a task that a developer could pick up. As a naive example, "Possible follow up tasks:\n - Remove redundant comments from convex/users.ts, such as '// set x to 5' before 'x = 5'.\n - Add getMeetingByIdOrCrash and search convex/ for files that could use it."

            Use the repository's CLAUDE.md for guidance on style and conventions. Be constructive and helpful in your feedback.

            Use the same numbered list throughout the review. If you have 1,2,3 and then you move to another section, use 4,5,6, which makes it easier to respond to specific points. Sub bullets like 4.1 are also ok.

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/sdk#command-line for available options
          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'
