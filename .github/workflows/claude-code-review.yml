name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Please review this pull request.
            Please list things that should be improved, not things that are already ok.
            Please phrase your response as a numbered list, where each list item is a suggestion for something to improve, phrased as a task for a developer. If you want, you can then add a newline and say "Why: ...".

            Please split up the feedback into "In scope for the PR" (e.g a bug added) - things where this PR might have made the code worse, "Follow up tasks" - things that seem good but we might avoid in the current PR because of scope creep, and "Unrelated problems found in the code" - if you notice something wrong with the project while doing your review, like a bug somewhere eles.
            Don't repeat bullet points please. (it isn't very important if a bullet is in the 2nd or 3rd section)

            For example:

            ```
            # Suggestions for current PR:

            1. Fix the code duplication in ... by extracting a function named ... .
            2. Undo the auth change in the file ... . Why: Scope creep, ...

            # Possible follow up tasks:

            3. Add a setting in the config screen for ...

            # Unrelated problems found in the code:

            4. Remove the hardcoded API key from ...
            ```

            It is ok to use emojis to indicate how important things are (like: ❌ for something that seems important. ⚠️ for probably-good-to-fix. you can also improvise with emojis and have fun)

            This is nice because it allows us to say "let's fix 1,2,4" or "let's do 3 in a separate PR".

            Here are main topics to review:
            - Code quality and best practices (see relevant claude.md files, like convex/claude.md of convex/ files were changed)
            - Security concerns (are security assumptions grouped in one place which is simple to review?)
            - DRY (also in md. md shouldn't repeat code and shouldn't write the same thing twice, like "reminder: how to run the backend: ..." is bad if somewhere else already wrote how to run the backend)
            - Scope creep (is the PR trying to solve too many problems at once?)
            - API changes / function signature changes (clean readable APIs are more important than the implementation)
            - UX / user flow problems ("don't make me think"). What is the user trying to do in this screen? Is the screen reactive and simple for that? Does it have too many unrelated options?

            Things that don't matter:
            - Performance (it is better to keep simple maintainable code. avoid premature optimization.)

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/sdk#command-line for available options
          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'
